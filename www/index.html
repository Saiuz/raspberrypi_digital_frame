<!DOCTYPE html>
<head>
 <meta charset="utf-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="mystyle.css">
 
</head>
<html>
<body>
<h2></h2>
<p id="main"></p>
<script>
function on_off_hour() {
  console.log('Starting function on/off');
  get_DayObject();
};

function get_DayObject() {
  var d = new Date();
  var Today = (d.getDay());
  var NowHour = d.getHours(); 
  console.log('Now is day '+Today+' hour '+NowHour);
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
  if (this.readyState == 4 && this.status == 200) {
    NewState=DisplayDay(this,Today,NowHour);
    UpdateState(this,Today,NowHour,NewState);
    }
  };
xhttp.open("GET", "/api/days/", true);
xhttp.send();
};

function DisplayDay(Days,Today,NowHour){
//  console.log(JSON.parse(Days.responseText)._items[0]._etag);
//  console.log(Today);
  
  var Hours=JSON.parse(Days.responseText)._items[Today].hours;
  State=Hours[NowHour]
  if ( State == "1" ){
    document.getElementById("main").innerHTML ="<br><b>Set screen Off</br>";
    NewState=0;
    }
  else{
    document.getElementById("main").innerHTML ="<br><b>Set screen On</br>";
    NewState=1;
  };
    return (NewState);
}

function UpdateState(DaysObject,Today,NowHour,NewState){
 
  console.log(DaysObject,Today,NowHour,NewState);
  var Hours=JSON.parse(DaysObject.responseText)._items[Today].hours;
  var Etag=JSON.parse(DaysObject.responseText)._items[Today]._etag;

  console.log(Hours+" "+NewState);
  NewHours=Hours.slice(0,NowHour)+NewState+Hours.slice(NowHour+1,Hours.length);
  console.log(NewHours.length);
  var sendData = $('#data').val();
  $.ajax({
    headers: {
      'If-Match': Etag,
      'Content-Type':'application/json'
      },
      url: '/api/days/'+(Today+1),
      type: 'PATCH',   
      data: JSON.stringify({ 'hours': NewHours,}),
      success: function () {
         }
        });
}


function GetImageLocation(Order,root) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
  if (this.readyState == 4 && this.status == 200) {
    if (Order == 'Download') {
    PostDownloadLink((JSON.parse(this.responseText)._items[0].image_name),root);
    }else{
    DisplayLink((JSON.parse(this.responseText)._items[0].image_name),root);
    }}
  };
xhttp.open("GET", "/api/state", true);
xhttp.send();
};

function GetRoot(Order){
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
  if (this.readyState == 4 && this.status == 200) {
    GetImageLocation(Order,JSON.parse(this.responseText)._items[0].value);
    }
  };
xhttp.open("GET", "/api/config", true);
xhttp.send();

}

function PostDownloadLink(ImageName,root){
  FileName=(ImageName.split(root)[1])
  Location='<a href="Photos/'+FileName+'" download link">'+FileName+'</a>';
  console.log(Location)
  document.getElementById("main").innerHTML =Location;
} 

function DisplayLink(ImageName,root){
  FileName=(ImageName.split(root)[1])
  Location='<img src="Photos/'+FileName+'" width=100%>';
  console.log(Location)
  document.getElementById("main").innerHTML +=Location;
} 

function resizeIframe(iframeID) 
{       
    var iframe = window.parent.document.getElementById(iframeID);
    var container = document.getElementById('content');
    iframe.style.height = container.offsetHeight + 'px';            
} 

function Reload(){
location.reload();

}

</script>

<!DOCTYPE html>
<head>
<title>The Frame</title>
</head>
<body>

<script>GetRoot('Show')</script>
<p><button class="button1" onclick="on_off_hour()">Screen on/off</button></p>
<p><button class="button2" onclick="GetRoot('Download')">Download Image</button></p>
<button class="button3" onclick="Reload()">Reload</button>

<!--
<button>Send an HTTP POST request to a page and get the result back</button>
<table id="mixed">
<tr><th>01</th><th>02</th><th>03</th></tr>
</table>
--!>
</body>
</html>
